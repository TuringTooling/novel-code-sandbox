# Code Sandbox Environment for Novel Code Manager

This folder contains the configuration for a containerized sandbox environment specifically designed for running and testing Python tasks generated by the Novel Code Manager.

## Prerequisites

You need either Docker or Podman installed on your system:

- [Docker](https://docs.docker.com/get-docker/)
- [Podman](https://podman.io/getting-started/installation)
- [Podman Desktop](https://podman-desktop.io/) (optional GUI)

## Directory Structure

```
sandbox/
├── Containerfile.base       # Base container specification (optional, if used)
├── Containerfile.python     # Python 3 sandbox with uv
├── README.md                # This file
└── (Host Task Directory)    # A directory YOU create on your host machine to mount into the container
```

**Note:** You need to create a directory on your host machine (e.g., `./host_tasks`) which will be mounted into the container at `/tasks`. This directory will hold the individual task folders generated by the `unpack` command or created manually for testing.

## Building the Sandbox Image

Generally you would have a folder for each project so may be you have (or create) a folder named `ms-novel-code`. Within that folder you can extract the sandbox (if you got a zip file for it). This would create a folder `sandbox` in the `ms-novel-code` folder. The instruction assume that the `sandbox` folder is your current working directory.

Navigate to the **parent directory** (`ms-novel-code/`) in your terminal and run the build command, using the `-f` flag to specify the Containerfile location. Choose either Docker or Podman.

**Using Docker:**

```bash
# Run from ms-novel-code/ directory
docker build -t novel-code-sandbox:latest -f sandbox/Containerfile.python .
```

**Using Podman:**

```bash
# Run from ms-novel-code/ directory
podman build -t novel-code-sandbox:latest -f sandbox/Containerfile.python .
```

This will create the `novel-code-sandbox:latest` image containing Python 3, `uv`, and the necessary testing script (`test_runner_script.py`).

## Running the Sandbox Container

You need to run the container **before** using the `validate-batch` or `validate-code` commands from the Novel Code Manager.

**Important:**
1.  **Choose a name** for your running container (e.g., `novel-code-runner`). You will need this name for the `--container-id` argument.
2.  **Create a host directory** to share with the container (e.g., `mkdir ../host_tasks`).
3.  **Mount the host directory** to `/tasks` inside the container using the `-v` flag.

**Using Docker:**

```bash
# Create the host directory (if it doesn't exist)
# Assumes you are running this from the novel-code-manager directory
mkdir -p ../host_tasks

# Run the container in detached mode (-d)
docker run -d \
  --name novel-code-runner \
  -v "$(pwd)/../host_tasks:/tasks" \
  novel-code-sandbox:latest
```

**Using Podman:**

```bash
# Create the host directory (if it doesn't exist)
# Assumes you are running this from the novel-code-manager directory
mkdir -p ../host_tasks

# Run the container in detached mode (-d)
podman run -d \
  --name novel-code-runner \
  -v "$(pwd)/../host_tasks:/tasks" \
  novel-code-sandbox:latest
```

**Using Podman Desktop / Docker Desktop:**

1.  Open Podman Desktop or Docker Desktop.
2.  Navigate to the "Images" section.
3.  Find the `novel-code-sandbox:latest` image.
4.  Click the "Run" or "Play" button associated with the image.
5.  In the configuration dialog:
    *   **Crucially, set a container name** (e.g., `novel-code-runner`). You will need this for the `--container-id` argument when using the Novel Code Manager CLI.
    *   **Add a volume mount:**
        *   **Host Path / Source:** Select the host directory you created (e.g., `../host_tasks` relative to your `ms-novel-code` directory). You might need to provide the full absolute path.
        *   **Container Path / Destination:** Set this to `/tasks`.
    *   Ensure the container is set to run in detached mode (often the default or a checkbox).
6.  Click "Start" or "Run Container".

This starts the container in the background, names it, and mounts your host directory to `/tasks` inside the container.

## Usage

### 1. Individual Task Testing (Manual)

This is useful for debugging a single task.

1.  **Prepare Task Files:** Place the `main.py`, `tests.py`, and optionally `requirements.txt` for your task into a subdirectory within your host shared directory (e.g., `../host_tasks/B1-123/`).
2.  **Execute Test Runner:** Open a terminal and run the test runner script *inside* the container using `docker exec` or `podman exec`:

    ```bash
    # Using Docker
    docker exec novel-code-runner python /tasks/test_runner_script.py --task-dir /tasks/B1-123

    # Using Podman
    podman exec novel-code-runner python /tasks/test_runner_script.py --task-dir /tasks/B1-123
    ```

    Replace `novel-code-runner` with your container name and `/tasks/B1-123` with the correct path *inside the container* corresponding to your task folder.

    The script will:
    *   Check for `requirements.txt` inside `/tasks/B1-123`.
    *   If found, create a temporary venv inside `/tasks/B1-123/.venv`, install requirements using `uv`, and run tests using that venv.
    *   If not found, run tests using the container's default Python 3.12.
    *   Print the detailed test results as a JSON object to standard output.

### 2. Batch Validation (Using Novel Code Manager CLI)

The `validate-batch` and `validate-code` commands now use the running container.

1.  **Ensure Container is Running:** Make sure you have started the sandbox container as described above.
2.  **Run Validation Command:** From the `novel-code-manager` directory, run the validation command, providing the container name and the path to your *host* shared directory:

    ```bash
    # Example: Validate a batch file
    novel-code-manager validate-batch \
      --file ../data/batches/your_batch.jsonl \
      --container-id novel-code-runner \
      --shared-dir ../host_tasks \
      --output ../data/validation_summary.jsonl

    # Example: Detailed code validation
    novel-code-manager validate-code \
      --file ../data/batches/your_batch.jsonl \
      --container-id novel-code-runner \
      --shared-dir ../host_tasks \
      --output ../data/validation_details.jsonl
    ```

    The commands will:
    *   Connect to the specified container (`novel-code-runner`).
    *   For each task in the input file:
        *   Create a temporary folder (e.g., `B1-123`) inside your host shared directory (`../host_tasks`).
        *   Write `main.py`, `tests.py`, `data.json`, and `requirements.txt` (if needed) into that folder.
        *   Execute the necessary commands (`uv venv`, `uv pip install`, `python test_runner_script.py`) inside the container via `docker/podman exec`, targeting the corresponding `/tasks/B1-123` directory.
        *   Retrieve the JSON results.
        *   Clean up the temporary folder on the host.
    *   Aggregate results and save the output file.

## Accessing the Container Shell

If you need direct shell access to the running container:

```bash
# Using Docker
docker exec -it novel-code-runner /bin/bash

# Using Podman
podman exec -it novel-code-runner /bin/bash
```

## Stopping the Container

```bash
# Using Docker
docker stop novel-code-runner
docker rm novel-code-runner

# Using Podman
podman stop novel-code-runner
podman rm novel-code-runner
```
