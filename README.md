# Code Sandbox Environment for Novel Code Manager

This folder contains the configuration for a containerized sandbox environment specifically designed for running and testing Python tasks generated by the Novel Code Manager.

## Prerequisites

You need either Docker or Podman installed on your system:

- [Docker](https://docs.docker.com/get-docker/)
- [Podman](https://podman.io/getting-started/installation)
- [Podman Desktop](https://podman-desktop.io/) (optional GUI)

## Directory Structure

```
sandbox/
├── Containerfile.base       # Base container specification (optional, if used)
├── Containerfile.python     # Python 3 sandbox with uv
├── README.md                # This file
└── (Host Task Directory)    # A directory YOU create on your host machine to mount into the container
```

**Note:** You need to create a directory on your host machine (e.g., `./host_tasks`) which will be mounted into the container at `/tasks`. This directory will hold the individual task folders generated by the `unpack` command or created manually for testing.

## Building the Sandbox Image

Generally you would have a folder for each project so may be you have (or create) a folder named `ms-novel-code`. Within that folder you can extract the sandbox (if you got a zip file for it). This would create a folder `sandbox` in the `ms-novel-code` folder. The instruction assume that the `sandbox` folder is your current working directory.

Navigate to the **parent directory** (`ms-novel-code/`) in your terminal and run the build command, using the `-f` flag to specify the Containerfile location. Choose either Docker or Podman.

**Using Docker:**

```bash
# Run from ms-novel-code/ directory
docker build -t ms-novel-code-sandbox:latest -f sandbox/Containerfile.python .
```

**Using Podman:**

```bash
# Run from ms-novel-code/ directory
podman build -t ms-novel-code-sandbox:latest -f sandbox/Containerfile.python .
```

This will create the `ms-novel-code-sandbox:latest` image containing Python 3, `uv`, and the necessary testing script (`test_runner_script.py`).

## Running the Sandbox Container


**Important:**

1.  **Create a host directory** to share with the container (e.g., `mkdir ../host_tasks`).
2.  **Mount the host directory** to `/tasks` inside the container using the `-v` flag.

**Using Docker:**

```bash
# Create the host directory (if it doesn't exist)
# Assumes you are running this from the novel-code-manager directory
mkdir -p ../host_tasks

# Run the container in detached mode (-d)
docker run -d \
  --name ms-novel-code-sandbox \
  -v "$(pwd)/../host_tasks:/tasks" \
  ms-novel-code-sandbox:latest
```

**Using Podman:**

```bash
# Create the host directory (if it doesn't exist)
# Assumes you are running this from the novel-code-manager directory
mkdir -p ../host_tasks

# Run the container in detached mode (-d)
podman run -d \
  --name ms-novel-code-sandbox \
  -v "$(pwd)/../host_tasks:/tasks" \
  ms-novel-code-sandbox:latest
```

**Using Podman Desktop / Docker Desktop:**

1.  Open Podman Desktop or Docker Desktop.
2.  Navigate to the "Images" section.
3.  Find the `ms-novel-code-sandbox:latest` image.
4.  Click the "Run" or "Play" button associated with the image.
5.  In the configuration dialog:
    *   **Crucially, set a container name** (e.g., `ms-novel-code-sandbox`). You will need this for the `--container-id` argument when using the Novel Code Manager CLI.
    *   **Add a volume mount:**
        *   **Host Path / Source:** Select the host directory you created (e.g., `../host_tasks` relative to your `ms-novel-code` directory). You might need to provide the full absolute path.
        *   **Container Path / Destination:** Set this to `/tasks`.
    *   Ensure the container is set to run in detached mode (often the default or a checkbox).
6.  Click "Start" or "Run Container".

This starts the container in the background, names it, and mounts your host directory to `/tasks` inside the container.

## Test runner script

One the container setup is done, copy the `test_runner_script.py` (provided separately) in the `host_tasks` folder that we created earlier so it is available inside the container.

## Usage

### 1. Individual Task Testing (Manual)

This is useful for debugging a single task.

1.  **Prepare Task Files:** Place the `main.py`, `tests.py`, and optionally `requirements.txt` for your task into a subdirectory within your host shared directory (e.g., `../host_tasks/B1-123/`).
2.  **Execute Test Runner:** Open a terminal and run the test runner script *inside* the container using `docker exec` or `podman exec`:

    ```bash
    # Using Docker
    docker exec ms-novel-code-sandbox python /tasks/test_runner_script.py --task-dir /tasks/B1-123

    # Using Podman
    podman exec ms-novel-code-sandbox python /tasks/test_runner_script.py --task-dir /tasks/B1-123
    ```

    Replace `ms-novel-code-sandbox` with your container name and `/tasks/B1-123` with the correct path *inside the container* corresponding to your task folder.

    The script will:
    *   Check for `requirements.txt` inside `/tasks/B1-123`.
    *   If found, create a temporary venv inside `/tasks/B1-123/.venv`, install requirements using `uv`, and run tests using that venv.
    *   If not found, run tests using the container's default Python 3.12.
    *   Print the detailed test results as a JSON object to standard output.


## Accessing the Container Shell

If you need direct shell access to the running container:

```bash
# Using Docker
docker exec -it ms-novel-code-sandbox /bin/bash

# Using Podman
podman exec -it ms-novel-code-sandbox /bin/bash
```

## Stopping the Container

```bash
# Using Docker
docker stop ms-novel-code-sandbox
docker rm ms-novel-code-sandbox

# Using Podman
podman stop ms-novel-code-sandbox
podman rm ms-novel-code-sandbox
```
