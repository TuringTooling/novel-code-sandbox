# Code Sandbox Environment for Novel Code Manager

This folder contains the configuration for a containerized sandbox environment specifically designed for running and testing Python tasks generated by the Novel Code Manager. The sandbox supports three containerization technologies: **Docker**, **Podman**, and **NVIDIA Enroot**.

## Prerequisites

You need at least one of the following containerization tools installed on your system:

- [Docker](https://docs.docker.com/get-docker/)
- [Podman](https://podman.io/getting-started/installation)
- [NVIDIA Enroot](https://github.com/NVIDIA/enroot) - Particularly useful for HPC environments

### Optional GUI Tools (Docker/Podman only)
- [Podman Desktop](https://podman-desktop.io/) (optional GUI for Podman)
- [Docker Desktop](https://docs.docker.com/desktop/) (optional GUI for Docker)

**Note:** Enroot is primarily a CLI tool and doesn't have a desktop GUI interface.

## Directory Structure

```
sandbox/
├── Containerfile           # Python 3 sandbox with uv (used by Docker/Podman/Enroot)
├── README.md               # This file
├── build.sh                # Build script supporting all three tools
└── (Host Task Directory)   # A directory YOU create on your host machine to mount into the container
```

**Important:** You need to create a directory on your host machine (e.g., `./host_tasks`) which will be mounted into the container at `/tasks`. This directory will hold the individual task folders generated by the `unpack` command or created manually for testing.

## Building the Sandbox Image

Generally you would have a folder for each project so may be you have (or create) a folder named `ms-novel-code`. Within that folder you can extract the sandbox (if you got a zip file for it). This would create a folder `sandbox` in the `ms-novel-code` folder. The instruction assume that the `sandbox` folder is your current working directory.

You can use the provided build script to build the container for any of the three supported technologies:

```bash
# From the sandbox directory - auto-detect available tool
./build.sh

# Or specify which tool to use explicitly
./build.sh docker
./build.sh podman
./build.sh enroot

# For enroot, you can also specify which build tool to use
./build.sh enroot docker    # Use Docker to build, then import to Enroot
./build.sh enroot podman    # Use Podman to build, then import to Enroot
```

The script will automatically detect available tools in the order: Enroot → Podman → Docker. When using Enroot without specifying a build tool, it will prefer Podman over Docker if both are available.

### Manual Build Instructions

#### Docker
```bash
# Run from sandbox/ directory
docker build -t ms-novel-code-sandbox:latest -f Containerfile .
```

#### Podman
```bash
# Run from sandbox/ directory
podman build -t ms-novel-code-sandbox:latest -f Containerfile .
```

#### Enroot
```bash
# Enroot requires building through Docker/Podman first, then importing
# Option 1: Via Docker (preferred - direct import from Docker daemon)
docker build -t ms-novel-code-sandbox:latest -f Containerfile .
enroot import dockerd://ms-novel-code-sandbox:latest
enroot create --name ms-novel-code-sandbox ms-novel-code-sandbox.sqsh

# Option 2: Via Podman (requires tar export/import)
podman build -t ms-novel-code-sandbox:latest -f Containerfile .
podman save ms-novel-code-sandbox:latest -o ms-novel-code-sandbox.tar
enroot import docker-archive://./ms-novel-code-sandbox.tar
enroot create --name ms-novel-code-sandbox ms-novel-code-sandbox.sqsh
rm ms-novel-code-sandbox.tar

# Option 3: Direct import from registry (if image is published)
enroot import docker://your-registry/ms-novel-code-sandbox:latest
enroot create --name ms-novel-code-sandbox ms-novel-code-sandbox.sqsh
```

## Running the Sandbox Container

**Important:**
1. **Create a host directory** to share with the container (e.g., `mkdir ../host_tasks`).
2. **Mount the host directory** to `/tasks` inside the container.

### Docker

```bash
# Create the host directory (if it doesn't exist)
# Assumes you are running this from the sandbox directory
mkdir -p ../host_tasks

# Run the container in detached mode (-d)
docker run -d \
  --name ms-novel-code-sandbox \
  -v "$(pwd)/../host_tasks:/tasks" \
  ms-novel-code-sandbox:latest
```

### Podman

```bash
# Create the host directory (if it doesn't exist)
# Assumes you are running this from the sandbox directory
mkdir -p ../host_tasks

# Run the container in detached mode (-d)
podman run -d \
  --name ms-novel-code-sandbox \
  -v "$(pwd)/../host_tasks:/tasks" \
  ms-novel-code-sandbox:latest
```

### Enroot (CLI Only)

Enroot has a different workflow and doesn't run containers as long-running daemons by default. Instead, you start containers for specific tasks.

**Important:** Enroot preserves the host user identity and has minimal isolation compared to Docker/Podman. This can cause issues with tools like `uv` that try to access the host home directory. Use the provided wrapper script or set environment variables to redirect cache directories.

```bash
# Create the host directory (if it doesn't exist)
mkdir -p ../host_tasks

# RECOMMENDED: Use the wrapper script for proper isolation
./enroot-sandbox.sh

# OR: Manual start with environment isolation
enroot start \
  --mount "$(pwd)/../host_tasks:/tasks" \
  --env UV_CACHE_DIR=/tasks/.uv_cache \
  --env UV_DATA_DIR=/tasks/.uv_data \
  --env PYTHONUSERBASE=/tasks/.python_user \
  --env HOME=/tasks \
  ms-novel-code-sandbox -- /bin/bash

# Run the test runner script with proper environment
enroot start \
  --mount "$(pwd)/../host_tasks:/tasks" \
  --env UV_CACHE_DIR=/tasks/.uv_cache \
  --env UV_DATA_DIR=/tasks/.uv_data \
  --env HOME=/tasks \
  ms-novel-code-sandbox -- \
  bash -c "cd /tasks/B1-123 && uv run python /tasks/test_runner_script_ng.py --task-dir /tasks/B1-123"
```

#### Enroot Advanced Options

```bash
# Mount multiple directories
enroot start \
  --mount "$(pwd)/../host_tasks:/tasks" \
  --mount "$(pwd)/../shared_data:/shared" \
  ms-novel-code-sandbox

# Set environment variables
enroot start \
  --mount "$(pwd)/../host_tasks:/tasks" \
  --env PYTHONPATH=/tasks \
  ms-novel-code-sandbox

# Start with root privileges (if needed for specific tasks)
enroot start --root \
  --mount "$(pwd)/../host_tasks:/tasks" \
  ms-novel-code-sandbox

# Start with GPU access (if Enroot is configured with nvidia-container-runtime)
enroot start \
  --mount "$(pwd)/../host_tasks:/tasks" \
  ms-novel-code-sandbox
```

### GUI Instructions (Docker Desktop / Podman Desktop)

1. Open Podman Desktop or Docker Desktop.
2. Navigate to the "Images" section.
3. Find the `ms-novel-code-sandbox:latest` image.
4. Click the "Run" or "Play" button associated with the image.
5. In the configuration dialog:
   * **Crucially, set a container name** (e.g., `ms-novel-code-sandbox`). You will need this for executing commands.
   * **Add a volume mount:**
     * **Host Path / Source:** Select the host directory you created (e.g., `../host_tasks` relative to your `ms-novel-code` directory). You might need to provide the full absolute path.
     * **Container Path / Destination:** Set this to `/tasks`.
   * Ensure the container is set to run in detached mode (often the default or a checkbox).
6. Click "Start" or "Run Container".

## Test Runner Script

Once the container setup is done, copy the `test_runner_script_ng.py` (provided separately) into the `host_tasks` folder that we created earlier so it is available inside the container.

## Usage

### 1. Individual Task Testing (Manual)

This is useful for debugging a single task.

1. **Prepare Task Files:** Place the `main.py`, `tests.py`, and optionally `requirements.txt` for your task into a subdirectory within your host shared directory (e.g., `../host_tasks/B1-123/`).

2. **Execute Test Runner:**

#### Docker/Podman
```bash
# Using Docker
docker exec ms-novel-code-sandbox bash -c "cd /tasks/B1-123; uv run python /tasks/test_runner_script_ng.py --task-dir /tasks/B1-123"

# Using Podman
podman exec ms-novel-code-sandbox bash -c "cd /tasks/B1-123; uv run python /tasks/test_runner_script_ng.py --task-dir /tasks/B1-123"
```

#### Enroot
```bash
# Using Enroot (single command execution)
enroot start --mount "$(pwd)/../host_tasks:/tasks" ms-novel-code-sandbox -- \
  bash -c "cd /tasks/B1-123 && uv run python /tasks/test_runner_script_ng.py --task-dir /tasks/B1-123"

# Or start an interactive session first
enroot start --mount "$(pwd)/../host_tasks:/tasks" ms-novel-code-sandbox
# Then inside the container:
cd /tasks/B1-123
uv run python /tasks/test_runner_script_ng.py --task-dir /tasks/B1-123
```

Replace `ms-novel-code-sandbox` with your container name and `/tasks/B1-123` with the correct path inside the container corresponding to your task folder.

### Guidelines

- If your task does not have any external library requirements, you can use the python version provided in the container.
- If your task has external requirements, store them in `requirements.txt` file in the task folder and then install them in a virtual environment. Example: `cd /tasks/B1-123; uv venv; uv pip install -r requirements.txt`

## Accessing the Container Shell

Direct shell access to the container might be easier when you are still developing code.

### Docker/Podman
```bash
# Using Docker
docker exec -it ms-novel-code-sandbox /bin/bash

# Using Podman
podman exec -it ms-novel-code-sandbox /bin/bash
```

### Enroot
```bash
# Using Enroot (always interactive by nature)
enroot start --mount "$(pwd)/../host_tasks:/tasks" ms-novel-code-sandbox

# Or explicitly request bash
enroot start --mount "$(pwd)/../host_tasks:/tasks" ms-novel-code-sandbox -- /bin/bash
```

## Container Management

### Docker
```bash
# Stop and remove container
docker stop ms-novel-code-sandbox
docker rm ms-novel-code-sandbox

# List containers
docker ps -a

# Remove image
docker rmi ms-novel-code-sandbox:latest
```

### Podman
```bash
# Stop and remove container
podman stop ms-novel-code-sandbox
podman rm ms-novel-code-sandbox

# List containers
podman ps -a

# Remove image
podman rmi ms-novel-code-sandbox:latest
```

### Enroot
```bash
# List Enroot containers
enroot list

# Remove Enroot container
enroot remove ms-novel-code-sandbox

# List available images
enroot list -f

# Remove image file
rm -f ~/.local/share/enroot/ms-novel-code-sandbox.sqsh
```

## Enroot-Specific Features

### Performance Benefits
Enroot is particularly beneficial in HPC environments because:
- **Lower overhead:** Minimal isolation compared to Docker/Podman
- **Better performance:** Direct access to host resources
- **GPU integration:** Seamless NVIDIA GPU access without special configuration
- **User namespace:** Runs as unprivileged user by default

### Choosing the Right Tool

**Use Docker/Podman when:**
- You need strong isolation between container and host
- You're developing on a personal workstation
- You want familiar container behavior
- You need easy debugging and development workflows

**Use Enroot when:**
- You're working in HPC/cluster environments
- You need maximum performance with minimal overhead
- You require seamless GPU access
- You're running in environments where Docker/Podman aren't available
- Your workload benefits from direct host resource access

### Integration with HPC Schedulers
Enroot works well with job schedulers like SLURM:

```bash
# Example SLURM job script using Enroot
#!/bin/bash
#SBATCH --job-name=novel-code-task
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --gres=gpu:1

# Start the sandbox with GPU support
enroot start --mount "$SLURM_SUBMIT_DIR/host_tasks:/tasks" ms-novel-code-sandbox -- \
  bash -c "cd /tasks/$TASK_ID && python main.py"
```

### Environment Configuration
You can customize Enroot behavior with configuration files:
- System-wide: `/etc/enroot/enroot.conf`
- User-specific: `~/.config/enroot/enroot.conf`

## Troubleshooting

### Common Issues

#### Enroot-specific
- **Image import fails:** Ensure Docker/Podman daemon is running when using `dockerarchive://` import
- **Mount permissions:** Enroot respects host filesystem permissions more strictly than Docker
- **Missing dependencies:** Some containers may need additional runtime dependencies on the host

#### General
- **Volume mount issues:** Ensure the host directory exists and has proper permissions
- **Port conflicts:** If running multiple containers, ensure they don't conflict
- **Resource limits:** Monitor CPU/memory usage in resource-constrained environments

### Getting Help
- Docker: [Documentation](https://docs.docker.com/)
- Podman: [Documentation](https://docs.podman.io/)
- Enroot: [GitHub Repository](https://github.com/NVIDIA/enroot) and [Usage Guide](https://github.com/NVIDIA/enroot/blob/master/doc/usage.md)
